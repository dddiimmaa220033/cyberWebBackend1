name: Update Project Status by Checklist

on:
  issues:
    types: [edited]

jobs:
  update-project-status:
    runs-on: ubuntu-latest
    steps:
      - name: Determine task completion state
        id: check_tasks
        run: |
          echo "üìã –ê–Ω–∞–ª—ñ–∑ —á–µ–∫–±–æ–∫—Å—ñ–≤..."
          body="${{ github.event.issue.body }}"
          total=$(echo "$body" | grep -c '\- \[' || true)
          checked=$(echo "$body" | grep -c '\- \[x\]' || true)

          echo "total=$total" >> $GITHUB_OUTPUT
          echo "checked=$checked" >> $GITHUB_OUTPUT

      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh jq

      - name: Authenticate gh CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Set Project Status
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          CHECKED: ${{ steps.check_tasks.outputs.checked }}
          TOTAL: ${{ steps.check_tasks.outputs.total }}
          PROJECT_NUMBER: 1 # üîÅ –∑–∞–º—ñ–Ω–∏ –Ω–∞ —Ç–≤—ñ–π –Ω–æ–º–µ—Ä –ø—Ä–æ—î–∫—Ç—É
        run: |
          echo "‚è≥ –û—Ç—Ä–∏–º—É—î–º–æ URL issue..."
          ISSUE_URL="https://github.com/$OWNER/$REPO/issues/$ISSUE_NUMBER"

          if [ "$TOTAL" -eq 0 ]; then
            STATUS="To Do"
          elif [ "$CHECKED" -eq "$TOTAL" ]; then
            STATUS="Done"
          else
            STATUS="In Progress"
          fi

          echo "üéØ –û–±—Ä–∞–Ω–æ —Å—Ç–∞—Ç—É—Å: $STATUS"

          echo "üîç –û—Ç—Ä–∏–º—É—î–º–æ ID –ø—Ä–æ—î–∫—Ç—É..."
          PROJECT_ID=$(gh project list --owner "$OWNER" --format json | jq -r '.[] | select(.number=='"$PROJECT_NUMBER"') | .id')

          echo "üîç –û—Ç—Ä–∏–º—É—î–º–æ ID –µ–ª–µ–º–µ–Ω—Ç–∞..."
          ITEM_ID=$(gh project item-list --owner "$OWNER" --project-id "$PROJECT_ID" --format json | jq -r '.[] | select(.content.url=="'"$ISSUE_URL"'") | .id')

          if [ -z "$ITEM_ID" ]; then
            echo "‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –µ–ª–µ–º–µ–Ω—Ç —É –ø—Ä–æ—î–∫—Ç—ñ!"
            exit 1
          fi

          echo "üìå –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ–ª–µ 'Status'..."
          FIELD_ID=$(gh project field-list --owner "$OWNER" --project-id "$PROJECT_ID" --format json | jq -r '.[] | select(.name=="Status") | .id')

          echo "üìå –û—Ç—Ä–∏–º—É—î–º–æ ID –≤–∞—Ä—ñ–∞–Ω—Ç—É —Å—Ç–∞—Ç—É—Å—É..."
          STATUS_OPTION_ID=$(gh project field-list --owner "$OWNER" --project-id "$PROJECT_ID" --format json | jq -r '.[] | select(.name=="Status") | .options[] | select(.name=="'"$STATUS"'") | .id')

          if [ -z "$FIELD_ID" ] || [ -z "$STATUS_OPTION_ID" ]; then
            echo "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –ø–æ–ª–µ –∞–±–æ –∑–Ω–∞—á–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É!"
            exit 1
          fi

          echo "‚úÖ –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å..."
          gh project item-edit "$ITEM_ID" \
            --field-id "$FIELD_ID" \
            --single-select-option-id "$STATUS_OPTION_ID"
