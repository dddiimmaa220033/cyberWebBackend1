name: Update Project Status by Checklist

on:
  issues:
    types: [edited]

jobs:
  update-project-status:
    runs-on: ubuntu-latest
    steps:
      - name: Determine task completion state
        id: check_tasks
        run: |
          echo "üìã –ê–Ω–∞–ª—ñ–∑ —á–µ–∫–±–æ–∫—Å—ñ–≤..."
          body="${{ github.event.issue.body }}"
          total=$(echo "$body" | grep -c '\- \[' || true)
          checked=$(echo "$body" | grep -c '\- \[x\]' || true)

          echo "total=$total" >> $GITHUB_OUTPUT
          echo "checked=$checked" >> $GITHUB_OUTPUT

      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh

      - name: Authenticate gh CLI
        run: echo "${{ secrets.GH_TOKEN }}" | gh auth login --with-token

      - name: Set Project Status
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          CHECKED: ${{ steps.check_tasks.outputs.checked }}
          TOTAL: ${{ steps.check_tasks.outputs.total }}
        run: |
          ISSUE_URL="https://github.com/$OWNER/$REPO/issues/$ISSUE_NUMBER"

          if [ "$TOTAL" -eq 0 ]; then
            STATUS="To Do"
          elif [ "$CHECKED" -eq "$TOTAL" ]; then
            STATUS="Done"
          else
            STATUS="In Progress"
          fi

          echo "üéØ –°—Ç–∞–≤–∏–º–æ —Å—Ç–∞—Ç—É—Å: $STATUS"

          # –û—Ç—Ä–∏–º–∞—Ç–∏ ID –µ–ª–µ–º–µ–Ω—Ç–∞ –∑ –ø—Ä–æ–µ–∫—Ç—É
          ITEM_ID=$(gh project item-list --owner "$OWNER" --format json --limit 100 | jq -r '.[] | select(.content.url=="'"$ISSUE_URL"'") | .id')

          if [ -z "$ITEM_ID" ]; then
            echo "‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –µ–ª–µ–º–µ–Ω—Ç —É –ø—Ä–æ—î–∫—Ç—ñ!"
            exit 1
          fi

          # –û—Ç—Ä–∏–º–∞—Ç–∏ ID –ø–æ–ª—è "Status"
          FIELD_ID=$(gh project field-list --owner "$OWNER" --format json | jq -r '.[] | select(.name=="Status") | .id')

          # –û—Ç—Ä–∏–º–∞—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è —Å—Ç–∞—Ç—É—Å—É
          STATUS_OPTION_ID=$(gh project field-list --owner "$OWNER" --format json | jq -r '.[] | select(.name=="Status") | .options[] | select(.name=="'"$STATUS"'") | .id')

          if [ -z "$FIELD_ID" ] || [ -z "$STATUS_OPTION_ID" ]; then
            echo "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –ø–æ–ª–µ –∞–±–æ –∑–Ω–∞—á–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É!"
            exit 1
          fi

          # –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
          gh project item-edit "$ITEM_ID" --field-id "$FIELD_ID" --single-select-option-id "$STATUS_OPTION_ID"
